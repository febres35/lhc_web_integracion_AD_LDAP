function chatsyncuser(){lhinst.syncusercall()}function chatsyncuserpending(){lhinst.chatsyncuserpending()}lhinst.addmsgurluser="chat/addmsguser/",lhinst.addmsgurluserchatbox="chatbox/addmsguser/",lhinst.syncuser="chat/syncuser/",lhinst.userclosechaturl="chat/userclosechat/",lhinst.checkchatstatus="chat/checkchatstatus/",lhinst.checkChatStatusTimeout=null,lhinst.addmsguserchatbox=function(e){var t=!1,s={msg:$("#CSChatMessage").val(),nick:$("#CSChatNick").val()},i=1==this.isWidgetMode?"/(mode)/widget":"";$("#CSChatMessage").val("");var a=this;$.postJSON(this.wwwDir+this.addmsgurluserchatbox+this.chat_id+"/"+this.hash+i+this.appendSyncArgument,s,(function(e){"f"==e.error?(LHCCallbacks.addmsguserchatbox&&LHCCallbacks.addmsguserchatbox(a,{chat_id:a.chat_id,data:e}),a.syncusercall()):alert(e.or)})),t!=$("#CSChatNick").val()&&window.postMessage&&parent&&(parent.postMessage("lhc_chb:nick:"+$("#CSChatNick").val(),"*"),t=$("#CSChatNick").val())},lhinst.updateMessageRow=function(e){var t=1==this.isWidgetMode?"/(mode)/widget":"";$.getJSON(this.wwwDir+"chat/getmessage/"+this.chat_id+"/"+this.hash+"/"+e+t,(function(t){"f"==t.error&&($("#msg-"+e).replaceWith(t.msg),$("#msg-"+e).addClass("bg-success"),setTimeout((function(){$("#msg-"+e).removeClass("bg-success")}),2e3))}))},lhinst.addmsguser=function(e){LHCCallbacks.addmsguserbefore&&LHCCallbacks.addmsguserbefore(this);var t=$("#CSChatMessage"),s={msg:t.val()},i=1==this.isWidgetMode?"/(mode)/widget":"";t.val("");var a=this;$("#lhc-mic-icon").length>0&&($("#lhc-send-icon").hide(),$("#lhc-mic-icon").show(),$("#voice-control-message").hide());try{ee.emitEvent("messageSend",[{chat_id:this.chat_id,hash:this.hash,msg:s.msg}]),sessionStorage&&sessionStorage.setItem("lhc_ttxt","")}catch(e){}if(t.hasClass("edit-mode"))s.msgid=t.attr("data-msgid"),$.postJSON(this.wwwDir+"chat/updatemsguser/"+this.chat_id+"/"+this.hash+i,s,(function(e){if("f"==e.error)return t.removeClass("edit-mode"),t.removeAttr("data-msgid"),$("#msg-"+s.msgid).replaceWith(e.msg),!0}));else{var n=$("#messagesBlock");n.append('<div class="message-row response pending-storage"><div class="msg-body">'+$("<div>").text(s.msg).html()+"</div></div>"),n.scrollTop(n.prop("scrollHeight")),0==this.addingUserMessage&&0==this.addUserMessageQueue.length?(this.addingUserMessage=!0,$.postJSON(this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+i,s,(function(e){if("f"==e.error)LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(a,e),a.syncusercall();else{$(".pending-storage").remove(),$("#CSChatMessage").val(s.msg);var t=$("#id-operator-typing");t.html(e.r),t.css("visibility","visible"),setTimeout((function(){0==a.operatorTyping&&$("#id-operator-typing").css("visibility","hidden")}),3e3)}a.addingUserMessage=!1})).fail((function(e){$("#CSChatMessage").val(t.val()+" "+s.msg);var i=$("#id-operator-typing");i.html("You have weak internet connection or the server has problems. Try to send the message again."),i.css("visibility","visible"),setTimeout((function(){0==a.operatorTyping&&$("#id-operator-typing").html("").css("visibility","hidden")}),5e3),$(".pending-storage").remove(),a.addingUserMessage=!1,a.addUserMessageQueue.length>0&&a.addDelayedMessage()}))):(this.addUserMessageQueue.push({retries:0,pdata:s,url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+i}),clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout((function(){a.addDelayedMessage()}),50))}},lhinst.addMessagesToStore=function(e){for(var t=1==this.isWidgetMode?"/(mode)/widget":"",s=e.length,i=0;i<s;i++)this.addUserMessageQueue.push({retries:0,pdata:{msg:e[i]},url:this.wwwDir+this.addmsgurluser+this.chat_id+"/"+this.hash+t});this.addDelayedMessage()},lhinst.addDelayedMessage=function(){var e=this;if(0==this.addingUserMessage){if(this.addUserMessageQueue.length>0){var t=this.addUserMessageQueue.shift();this.addingUserMessage=!0;var s=[];s.push(t.pdata.msg);for(var i=this.addUserMessageQueue.length,a=0;a<i;a++)s.push(this.addUserMessageQueue[a].pdata.msg);this.addUserMessageQueue=[],$.postJSON(t.url,{msg:s.join("[[msgitm]]")},(function(t){"f"==t.error&&(LHCCallbacks.addmsguser&&LHCCallbacks.addmsguser(e,t),e.syncusercall()),e.addingUserMessage=!1,e.addUserMessageQueue.length>0&&(clearTimeout(e.addDelayedTimeout),e.addDelayedMessage())})).fail((function(){e.addingUserMessage=!1}))}}else clearTimeout(this.addDelayedTimeout),this.addDelayedTimeout=setTimeout((function(){e.addDelayedMessage()}),50)},lhinst.switchToOfflineForm=function(){var e=$("#form-start-chat");return e.attr("action",$("#form-start-chat").attr("action")+"/(switchform)/true/(offline)/true/(leaveamessage)/true/(department)/"+$("#id_DepartamentID").val()),e.submit(),!1},lhinst.disableChatSoundUser=function(e){return"volume_off"==e.find("> i").text()?(confLH.new_message_sound_user_enabled=1,e.find("> i").text("volume_up")):(confLH.new_message_sound_user_enabled=0,e.find("> i").text("volume_off")),window.postMessage&&parent&&("volume_off"==e.find("> i").text()?parent.postMessage("lhc_ch:s:0","*"):parent.postMessage("lhc_ch:s:1","*")),!1},lhinst.prestartChat=function(e,t){if(0==t.find(".form-protected").length){if(1!=t.attr("lhc-captcha-submitted"))t.attr("lhc-captcha-submitted",1),t.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+e,(function(s){t.append('<input type="hidden" value="'+e+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+e+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),t.submit()})),1==(s=1==t.attr("key-up-started"))&&(jQuery("<div/>",{class:"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").scrollTop($("#messagesBlock").prop("scrollHeight")),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val(""));else $("#messagesBlock").length>0&&(jQuery("<div/>",{class:"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").scrollTop($("#messagesBlock").prop("scrollHeight"))),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1}if(1==t.find("#hasFormExtraField").length)return!0;if(1!=t.attr("lhc-form-submitted")){t.attr("lhc-form-submitted",1);var s,i=this;1==(s=1==t.attr("key-up-started"))&&t.append('<input type="hidden" value="1" name="keyUpStarted" />'),$.post(t.attr("action"),t.serialize(),(function(e){var t=$("#id_Question").val();try{sessionStorage&&sessionStorage.setItem("lhc_ttxt",t)}catch(e){}$("head > script");var s=$("head"),a=[];$("head > script").each((function(){var e=$(this);void 0!==e.attr("src")&&a.push(e.attr("src"))})),$("<div>").html(e).find("> script").each((function(){var e=$(this);void 0===e.attr("src")?s.append(e):-1==a.indexOf(e.attr("src"))&&s.append('<script src="'+e.attr("src")+'"><\/script>')})),paramsDocument="<script>lhinst.addMessagesToStore("+JSON.stringify(i.pendingMessagesToStore)+")<\/script>",$("#widget-layout").html($("<div>").html(e).find("#widget-layout").html()),$("#widget-layout-js").html($("<div>").html(e).find("#widget-layout-js").html()+paramsDocument)})),0==s&&$("#id_Question").val("")}else $("#messagesBlock").length>0&&(jQuery("<div/>",{class:"message-row response",text:$("#id_Question").val()}).appendTo("#messagesBlock").prepend('<span class="usr-tit vis-tit">'+visitorTitle+"</span>"),$("#messagesBlock").scrollTop($("#messagesBlock").prop("scrollHeight"))),this.pendingMessagesToStore.push($("#id_Question").val()),$("#id_Question").val("");return!1},lhinst.addCaptcha=function(e,t){return 0!=t.find(".form-protected").length||(t.find('input[type="submit"]').attr("disabled","disabled"),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+e,(function(s){t.append('<input type="hidden" value="'+e+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+e+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),t.submit()})),!1)},lhinst.addCaptchaSubmit=function(e,t){return 0==t.find(".form-protected").length&&(t.find('input[type="submit"]').attr("disabled","disabled"),t.find("#ChatSendButtonContainer").remove(),t.find("#id_Question").attr("readonly","readonly"),"undefined"!=typeof formSubmitted&&(formSubmitted=!0),$.getJSON(this.wwwDir+"captcha/captchastring/form/"+e,(function(s){if(t.append('<input type="hidden" value="'+e+'" name="captcha_'+s.result+'" /><input type="hidden" value="'+e+'" name="tscaptcha" /><input type="hidden" class="form-protected" value="1" />'),window.FormData)try{var i=new FormData(t[0]),a=new XMLHttpRequest;a.addEventListener("readystatechange",(function(e){var t,s;try{s=e.target.readyState,e.target.responseText,t=e.target.status}catch(e){return}4==s&&"200"==t&&e.target.responseText&&(-1==a.getResponseHeader("Content-Type").indexOf("application/json")?$("#widget-content-body").html(e.target.responseText):location.replace(jQuery.parseJSON(e.target.responseText).location))}),!1);var n=t.attr("action");""!=n?a.open("POST",n+"/(ajaxmode)/true",!0):a.open("POST",document.location+"&ajaxmode=true",!0),a.send(i)}catch(e){return!1}else t.submit()})),!1)},lhinst.addFileUserUploadOnline=function(e,t){var s=this;$("#fileuploadonline").fileupload({url:this.wwwDir+"file/uploadfileonline/"+e.online_user_vid,dataType:"json",add:function(t,s){var i=[],a=e.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(e.ft_msg),s.originalFiles[0].size>e.fs&&i.push(e.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(i,a){s.updateOnlineFilesUser(e.online_user_vid),t&&t(e.online_user_vid)},progressall:function(e,t){var s=parseInt(t.loaded/t.total*100,10);$("#upload-status-user-online").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},lhinst.addFileUploadOnlineUser=function(e,t){var s=this;$("#fileupload-online-user-"+e.online_user_id).fileupload({url:this.wwwDir+"file/uploadfileadminonlineuser/"+e.online_user_id,dataType:"json",add:function(t,s){var i=[],a=e.ft_op;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(e.ft_msg),s.originalFiles[0].size>e.fs&&i.push(e.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(i,a){t&&t(e.online_user_id),s.updateOnlineFiles(e.online_user_id)},dropZone:$("#drop-zone-online-user-"+e.online_user_id),progressall:function(t,s){var i=parseInt(s.loaded/s.total*100,10);$("#upload-status-admin-"+e.online_user_id).html(i+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},lhinst.eNick=function(){lhc.revealModal({url:WWW_DIR_JAVASCRIPT+"chat/editnick/"+this.chat_id+"/"+this.hash})},lhinst.enableVisitorEditor=function(){$("#ChatMessageContainer").removeClass("hide"),$("#CSChatMessage").focus()},lhinst.disableVisitorEditor=function(){$("#ChatMessageContainer").addClass("hide")},lhinst.buttonClicked=function(e,t,s,i){null==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.scrollTop(n),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash,{payload:e,id:t,processed:void 0===i||0==i},(function(e){void 0!==i&&!1!==i||$(".meta-message-"+t).remove();var s=a.prop("scrollHeight");a.scrollTop(s),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},lhinst.editGenericStep=function(e,t){var s=$("#messagesBlock"),i=s.prop("scrollHeight");s.scrollTop(i),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/editgenericstep",{payload:e,id:t},(function(e){var t=s.prop("scrollHeight");s.scrollTop(t),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},lhinst.updateTriggerClicked=function(e,t,s,i){null==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.scrollTop(n),this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/triggerclicked",{payload:e,id:t,processed:void 0===i||0==i},(function(e){void 0!==i&&!1!==i||$(".meta-message-"+t).remove();var s=a.prop("scrollHeight");a.scrollTop(s),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},lhinst.updateChatClicked=function(e,t,s,i){null==s.attr("data-no-change")&&(s.attr("disabled","disabled"),s.prepend('<i class="material-icons lhc-spin">loop</i>'));var a=$("#messagesBlock"),n=a.prop("scrollHeight");a.scrollTop(n),lhinst.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/updatebuttonclicked/"+this.chat_id+"/"+this.hash,{payload:e,id:t,processed:void 0===i||0==i},(function(e){void 0!==i&&!1!==i||$(".meta-message-"+t).remove();var s=a.prop("scrollHeight");a.scrollTop(s),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()},lhinst.dropdownClicked=function(e,t){null==t.attr("data-no-change")&&(t.attr("disabled","disabled"),t.prepend('<i class="material-icons lhc-spin">loop</i>'));var s=$("#messagesBlock"),i=s.prop("scrollHeight");s.scrollTop(i),""!=$("#generic_list-"+e).val()?(this.syncroRequestSend=!0,clearTimeout(this.userTimeout),$.get(this.wwwDir+"genericbot/buttonclicked/"+this.chat_id+"/"+this.hash+"/(type)/valueclicked",{payload:$("#id_generic_list-"+e).val(),id:e},(function(t){$(".meta-message-"+e).remove();var i=s.prop("scrollHeight");s.scrollTop(i),lhinst.forceBottomScroll=!0,lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})).fail((function(){lhinst.syncroRequestSend=!1,lhinst.enableVisitorEditor(),lhinst.syncusercall()})),lhinst.focusUserText()):alert("Please choose!")},lhinst.focusUserText=function(){$("#CSChatMessage").focus()},lhinst.unhideDelayed=function(e){var t=$("#messagesBlock > #msg-"+e);t.nextUntil(".meta-hider").removeClass("hide"),t.remove();var s=$("#messagesBlock"),i=s.prop("scrollHeight");if(s.find(".meta-auto-hide").hide(),s.find(".message-row").last().find(".meta-auto-hide").show(),i=s.prop("scrollHeight"),s.find(".pending-storage").remove(),s.scrollTop(i+2e3),this.delayQueue.length>0){var a=lhinst.delayQueue.pop();setTimeout((function(){lhinst.unhideDelayed(a.id)}),1e3*a.delay),$("#msg-"+a.id).removeClass("hide"),$("#msg-"+a.id+" .msg-body").removeClass("hide")}else lhinst.delayed=!1},lhinst.chatsyncuserpending=function(){var e=1==this.isWidgetMode?"/(mode)/widget":"",t=null!==this.theme?"/(theme)/"+this.theme:"";clearTimeout(this.checkChatStatusTimeout);var s=this;$.getJSON(this.wwwDir+this.checkchatstatus+this.chat_id+"/"+this.hash+e+t,{},(function(e){ee.emitEvent("checkChatStatus",[s.chat_id,e]),s.chatStatus=e.status,"false"==e.error&&("false"==e.activated?("false"!=e.result&&$("#status-chat").html(e.result),""!=e.ru&&document.location.replace(e.ru),s.checkChatStatusTimeout=setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)):($("#status-chat").html(e.result),e.closed&&1==e.closed&&(ee.emitEvent("chatClosedCheckStatus",[s.chat_id]),s.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed","*"):s.chatClosed())))})).fail((function(){setTimeout(chatsyncuserpending,confLH.chat_message_sinterval)}))},lhinst.setTheme=function(e){this.theme=e},lhinst.setSurvey=function(e){this.survey=e},lhinst.voteAction=function(e){var t=this.chat_id;$.postJSON(this.wwwDir+"chat/voteaction/"+this.chat_id+"/"+this.hash+"/"+e.attr("data-id"),{},(function(e){"false"==e.error&&(LHCCallbacks.uservoted&&LHCCallbacks.uservoted(t),0==e.status?($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):1==e.status?($(".up-vote-action").addClass("up-voted"),$(".down-vote-action").removeClass("down-voted")):2==e.status&&($(".up-vote-action").removeClass("up-voted"),$(".down-vote-action").addClass("down-voted")))}))},lhinst.sendemail=function(){$.postJSON(this.wwwDir+"chat/sendchat/"+this.chat_id+"/"+this.hash,{csfr_token:confLH.csrf_token,email:$('input[name="UserEmail"]').val()},(function(e){"false"==e.error?$("#myModal").modal("hide"):($("#user-action .alert-box").remove(),$("#user-action").prepend(e.result))}))},lhinst.closeWindow=function(){null!==this.survey&&0==this.surveyShowed?(this.surveyShowed=!0,this.chatClosed()):(window.open("","_self",""),window.close(),parent.postMessage("lhc_chat_closed_explicit","*"))},lhinst.setLastUserMessageID=function(e){this.last_message_id=e},lhinst.setChatID=function(e){this.chat_id=e},lhinst.setCloseWindowOnEvent=function(e){this.closeWindowOnChatCloseDelete=e},lhinst.setWidgetMode=function(e){this.isWidgetMode=e},lhinst.setEmbedMode=function(e){this.isEmbedMode=e},lhinst.setSyncUserURL=function(e){this.syncuser=e},lhinst.editPreviousUser=function(){var e=$("#CSChatMessage");""==e.val()&&$.getJSON(this.wwwDir+"chat/editprevioususer/"+this.chat_id+"/"+this.hash,(function(t){"f"==t.error&&(e.val(t.msg),e.attr("data-msgid",t.id),e.addClass("edit-mode"),$("#msg-"+t.id).addClass("edit-mode"),LHCCallbacks.editPreviousUser&&LHCCallbacks.editPreviousUser(t))}))},lhinst.addFileUserUpload=function(e){$("#fileupload").fileupload({url:this.wwwDir+"file/uploadfile/"+e.chat_id+"/"+e.hash,dataType:"json",add:function(t,s){var i=[],a=e.ft_us;a.test(s.originalFiles[0].type)||a.test(s.originalFiles[0].name)||i.push(e.ft_msg),s.originalFiles[0].size>e.fs&&i.push(e.fs_msg),i.length>0?alert(i.join("\n")):s.submit()},done:function(t,s){var i=s.response();null!=i&&null!=i.result&&"true"==i.result.error&&null!=i.result.error_msg&&alert(i.result.error_msg),LHCCallbacks.addFileUserUpload&&LHCCallbacks.addFileUserUpload(e.chat_id)},progressall:function(e,t){var s=parseInt(t.loaded/t.total*100,10);$("#id-operator-typing").css("visibility","visible"),$("#id-operator-typing").html(s+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},lhinst.setChatHash=function(e){this.hash=e},lhinst.updateUserSyncInterface=function(e,t){try{if("false"==t.error)if("true"!=t.blocked){if("false"!=t.result&&"true"==t.status){var s=$("#messagesBlock"),i=s.prop("scrollHeight"),a=Math.abs(i-s.prop("scrollTop")-s.prop("clientHeight"));i=s.prop("scrollHeight"),s.find(".pending-storage").remove(),s.append(t.result),s.find(".meta-auto-hide").hide(),s.find(".message-row").last().find(".meta-auto-hide").show(),(a<20||1==e.forceBottomScroll)&&(e.forceBottomScroll=!1,s.scrollTop(i+2e3)),1==confLH.new_message_sound_user_enabled&&"false"==t.uw&&e.playNewMessageSound(),e.last_message_id>0&&($("#msg-"+e.last_message_id).attr("data-op-id")==t.msop&&$("#msg-"+e.last_message_id+" > .usr-tit").text()===$("#msg-"+t.message_id+" > .usr-tit").text()||$("#msg-"+e.last_message_id).next().addClass("operator-changes")),e.last_message_id=t.message_id,"false"==t.uw&&e.isWidgetMode&&"undefined"!=typeof parent&&parent.postMessage("lhc_newopmsg","*")}else"true"!=t.status&&$("#status-chat").html(t.status);if(e.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval),"t"==t.cs&&e.chatsyncuserpending(),""!=t.ott&&"f"!=t.ott){var n=$("#id-operator-typing");n.text(t.ott),n.css("visibility","visible"),e.operatorTyping=!0}else"f"==t.ott&&(e.operatorTyping=!1,$("#id-operator-typing").css("visibility","hidden"));""!=t.op&&e.executeRemoteCommands(t.op)}else $("#status-chat").html(t.status),$("#ChatMessageContainer").remove(),$("#ChatSendButtonContainer").remove(),$("#id-operator-typing").css("visibility","hidden"),e.operatorTyping=!1,void 0!==t.op&&""!=t.op&&e.executeRemoteCommands(t.op),t.closed&&1==t.closed&&(ee.emitEvent("chatClosedSyncUser",[e.chat_id]),e.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed"+(void 0!==t.closed_arg?":"+t.closed_arg:""),"*"):(void 0!==t.closed_arg&&e.parseCloseArgs(t.closed_arg.split(":")),e.chatClosed()))}catch(t){e.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)}e.syncroRequestSend=!1},lhinst.parseCloseArgs=function(e){var t=e.length/2;for(i=0;i<t;i++){var s=e[2*i],a=e[2*i+1];"survey_id"==s&&(this.survey=a)}},lhinst.chatClosed=function(){if(null!==this.survey){var e=1==this.isWidgetMode?"/(mode)/widget":"",t=1==this.operatorTyping?"/(ot)/t":"",s=null!==this.theme?"/(theme)/"+this.theme:"",i=1==this.isEmbedMode?"/(modeembed)/embed":"",a=1==this.isWidgetMode?"fillwidget":"fill",n=1==this.explicitClose?"/(eclose)/t":"";return document.location.replace(this.wwwDir+"survey/"+a+"/(survey)/"+this.survey+"/(chatid)/"+this.chat_id+"/(hash)/"+this.hash+e+t+s+i+n),!0}return!1},lhinst.syncusercall=function(){var e=this;if(0==this.syncroRequestSend){clearTimeout(this.userTimeout),this.syncroRequestSend=!0;var t=1==this.isWidgetMode?"/(mode)/widget":"",s=1==this.operatorTyping?"/(ot)/t":"",i=null!==this.theme?"/(theme)/"+this.theme:"",a=1==this.isEmbedMode?"/(modeembed)/embed":"";$.getJSON(this.wwwDir+this.syncuser+this.chat_id+"/"+this.last_message_id+"/"+this.hash+t+s+i+a,{},(function(t){e.updateUserSyncInterface(e,t),LHCCallbacks.syncusercall&&LHCCallbacks.syncusercall(e,t),ee.emitEvent("syncUserCall",[e,t])})).fail((function(){e.syncroRequestSend=!1,e.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)}))}},lhinst.scheduleSync=function(){this.syncroRequestSend=!1,clearTimeout(this.userTimeout),this.userTimeout=setTimeout(chatsyncuser,confLH.chat_message_sinterval)},lhinst.executeRemoteCommands=function(operations){var inst=this;$.each(operations,(function(i,item){if(-1!=item.indexOf("lhinst."))try{eval(item)}catch(e){console.log(e)}else if(-1!=item.indexOf("lhc_ui_refresh")){var option=item.split(":")[1];1==option?lhinst.enableFileUpload():lhinst.disableFileUpload()}else inst.isWidgetMode?parent.postMessage(item,"*"):window.opener&&window.opener.postMessage(item,"*")}))},lhinst.disableFileUpload=function(){$("#fileupload").fileupload("destroy"),$("#ChatMessageContainer .dropdown-menu .flex-row .file-uploader").remove()},lhinst.startChatNewWindow=function(e,t){var s=window.open(this.wwwDir+"chat/single/"+e,"chatwindow-chat-id-"+e,"menubar=1,resizable=1,width=800,height=650");if(null!==s){s.focus();var i=this;setTimeout((function(){i.syncadmininterfacestatic()}),1e3),ee.emitEvent("chatStartOpenWindow",[e])}},lhinst.userclosedchat=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.ajax({type:"GET",url:this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash,cache:!1})},lhinst.userclosedchatembed=function(){window.postMessage&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close()},lhinst.continueChatFromSurvey=function(e){return this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?$.postJSON(this.wwwDir+"survey/backtochat/"+this.chat_id+"/"+this.hash+"/"+e,(function(e){e.closed?lhinst.userclosedchatembed():parent.postMessage("lhc_continue_chat","*")})):this.chatClosed(),!1},lhinst.explicitChatCloseByUser=function(){return this.explicitClose=!0,ee.emitEvent("endedChat",[]),this.isWidgetMode&&"undefined"!=typeof parent&&window.location!==window.parent.location?parent.postMessage("lhc_chat_closed_explicit","*"):0==this.chatClosed()&&window.close(),!1},lhinst.restoreWidget=function(e){window.postMessage&&window.opener&&(window.opener.postMessage("lhc_ch:hash:"+e,"*"),window.opener.postMessage("lhc_ch:hash_resume:"+e,"*"),window.opener.postMessage("lhc_open_restore","*"),window.close())},lhinst.userclosedchatandbrowser=function(){LHCCallbacks.userleftchatNotification&&LHCCallbacks.userleftchatNotification(this.chat_id),$.get(this.wwwDir+this.userclosechaturl+this.chat_id+"/"+this.hash+"/(eclose)/t",(function(e){lhinst.closeWindow()}))},lhinst.afterUserChatInit=function(){LHCCallbacks.afterUserChatInit&&LHCCallbacks.afterUserChatInit()},lhinst.sendHTML=function(e,t){"undefined"!=typeof parent&&window.location!==window.parent.location&&parent.postMessage("lhc_html_snippet:"+e+":"+t.type+"_"+t.id,"*")},lhinst.setDelay=function(e){var t=e.id,s=e.duration,i=e.delay,a=e.untill_message;i>0&&$("#msg-"+t).addClass("hide"),1==a&&$("#msg-"+t).nextUntil("message-admin").length>0||setTimeout((function(){if(0==lhinst.delayed){if(1==a)clearInterval(lhinst.intervalPending),lhinst.intervalPending=setInterval((function(){if($("#msg-"+t).nextUntil("message-admin").length>0)lhinst.unhideDelayed(t),$("#messagesBlock > #msg-"+t).remove(),clearInterval(lhinst.intervalPending);else if(!$("#msg-"+t).hasClass("meta-hider")){$("#msg-"+t).addClass("meta-hider message-row-typing"),$("#msg-"+t).removeClass("hide"),$("#msg-"+t+" .msg-body").removeClass("hide");var e=$("#messagesBlock"),s=e.prop("scrollHeight");e.find(".meta-auto-hide").hide(),e.find(".message-row").last().find(".meta-auto-hide").show(),s=e.prop("scrollHeight"),e.find(".pending-storage").remove(),e.scrollTop(s+2e3)}}),500);else if(lhinst.delayed=!0,$("#msg-"+t).addClass("meta-hider message-row-typing").nextUntil("meta-hider").addClass("hide"),setTimeout((function(){lhinst.unhideDelayed(t)}),1e3*s),$("#msg-"+t).removeClass("hide"),$("#msg-"+t+" .msg-body").removeClass("hide"),i>0){var e=$("#messagesBlock"),n=e.prop("scrollHeight");e.find(".meta-auto-hide").hide(),e.find(".message-row").last().find(".meta-auto-hide").show(),n=e.prop("scrollHeight"),e.find(".pending-storage").remove(),e.scrollTop(n+2e3)}}else lhinst.delayQueue.push({id:t,delay:s})}),1e3*i)},lhinst.enableFileUpload=function(){$.getJSON(this.wwwDir+"file/fileoptions/"+this.chat_id+"/"+this.hash,(function(e){$("#ChatMessageContainer .dropdown-menu .flex-row").prepend(e.html),e.options.ft_us=new RegExp("(.|/)("+e.options.ft_us+")$","i"),lhinst.addFileUserUpload(e.options)}))},lhinst.chooseFile=function(){document.getElementById("fileupload")&&document.getElementById("fileupload").click()},lhinst.executeExtension=function(e,t){if(null===document.getElementById("ext-"+e)){var s=document.getElementsByTagName("head")[0],i=document.createElement("script"),a=new Date;i.setAttribute("type","text/javascript"),i.setAttribute("src",WWW_DIR_LHC_WEBPACK_ADMIN.replace("/design/defaulttheme/js/admin/dist/","")+"/extension/"+e+"/design/"+e+"theme/js/"+e+".legacy.js?v="+a.getFullYear()+a.getMonth()+a.getDate()),i.setAttribute("id","ext-"+e),s.appendChild(i),i.onreadystatechange=i.onload=function(){ee.emitEvent(e+".init",[t])}}else ee.emitEvent(e+".init",[t])},lhinst.initTypingMonitoringUser=function(e){var t=this.wwwDir,s=this;try{sessionStorage&&sessionStorage.getItem("lhc_ttxt")&&""!=sessionStorage.getItem("lhc_ttxt")&&jQuery("#CSChatMessage").val(sessionStorage.getItem("lhc_ttxt"))}catch(e){}var i=!1;""!=jQuery("#CSChatMessage").val()?($("#lhc-send-icon").show(),$("#lhc-mic-icon").hide()):$("#lhc-mic-icon").length>0&&($("#lhc-send-icon").hide(),$("#lhc-mic-icon").show(),i=!0),jQuery("#CSChatMessage").bind("keyup",(function(a){try{sessionStorage&&sessionStorage.setItem("lhc_ttxt",$(this).val())}catch(e){}var n=$(this)[0];n.style.height="5px",1==i&&(""!=$(this).val()?($("#lhc-send-icon").show(),$("#lhc-mic-icon").hide(),$("#voice-control-message").hide()):($("#lhc-send-icon").hide(),$("#lhc-mic-icon").show()));var o=n.scrollHeight+3;if(o>48&&(o+=10,n.style.overflowY=o>90?"auto":"hidden"),n.style.height=o+"px",0==s.is_typing)clearTimeout(s.typing_timeout),LHCCallbacks.initTypingMonitoringUserInform?(s.typing_timeout=setTimeout((function(){ee.emitEvent("visitorTypingStopped",[{chat_id:e,hash:s.hash}])}),3e3),ee.emitEvent("visitorTyping",[{chat_id:e,hash:s.hash,status:!0,msg:$(this).val()}])):(s.is_typing=!0,$.postJSON(t+"chat/usertyping/"+e+"/"+s.hash+"/true",{msg:$(this).val()},(function(t){s.typing_timeout=setTimeout((function(){s.typingStoppedUser(e)}),3e3),LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[e,!0])})).fail((function(){s.typing_timeout=setTimeout((function(){s.typingStoppedUser(e)}),3e3)})));else{clearTimeout(s.typing_timeout),s.typing_timeout=setTimeout((function(){s.typingStoppedUser(e)}),3e3);var l=$(this).val();s.currentMessageText!=l&&Math.abs(s.currentMessageText.length-l.length)>6&&(s.currentMessageText=l,LHCCallbacks.initTypingMonitoringUserInform?ee.emitEvent("visitorTyping",[{chat_id:e,hash:s.hash,status:!0,msg:$(this).val()}]):$.postJSON(t+"chat/usertyping/"+e+"/"+s.hash+"/true",{msg:l},(function(t){LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[e,!0])})))}}))},lhinst.typingStoppedUser=function(e){var t=this;1==t.is_typing&&(LHCCallbacks.typingStoppedUserInform?(t.is_typing=!1,ee.emitEvent("visitorTypingStopped",[{chat_id:e,hash:this.hash,status:!1}])):$.getJSON(this.wwwDir+"chat/usertyping/"+e+"/"+this.hash+"/false",{},(function(s){t.is_typing=!1,LHCCallbacks.initTypingMonitoringUser&&ee.emitEvent("initVisitorTyping",[e,!1])})).fail((function(){t.is_typing=!1})))},this.afterChatWidgetInit=function(){LHCCallbacks.afterChatWidgetInit&&LHCCallbacks.afterChatWidgetInit()};